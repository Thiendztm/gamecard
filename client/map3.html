<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map 3</title>
    <link rel="stylesheet" href="css/audio.css">
    <link rel="stylesheet" href="css/character-sprites.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="character-functions.js" defer></script>
    <script src="music-manager.js" defer></script>
    <script src="memory-optimization.js" defer></script>
    <script src="skills-system.js" defer></script>
    <script src="skill-manager.js" defer></script>
    <script src="combatSystem.js" defer></script>
</head>
<body style="background-image: url('/DesignHud/map3.png');background-repeat: no-repeat; background-size: cover; background-position: center; height: 100vh; width: 100vw; margin: 0; padding: 0;">
    <div class="music-control">
        <div class="music-icon" id="musicIcon">üéµ</div>
        <div class="volume-control">
            <span class="volume-text" id="volumeText">50%</span>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
        </div>
    </div>
    
    <div class="action-panel">
        <div class="action-items">
            <div class="action-item">ƒê√°nh</div>
            <div class="action-item">K·ªπ nƒÉng</div>
            <div class="action-item">Ph√≤ng th·ªß</div>
        </div>
        <div class="user-section"></div>
    </div>
    
    <audio id="backgroundMusic" loop preload="none">
        <source src="/audio/12. The Young Descendant of Tepes.mp3" type="audio/mpeg">
    </audio>
    
    <script>
        const audio = document.getElementById('backgroundMusic');
        const musicIcon = document.getElementById('musicIcon');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeText = document.getElementById('volumeText');
        
        let isPlaying = false;
        
        // Set initial volume
        audio.volume = 0.5;
        
        
        // Auto-play when page loads
        window.addEventListener('load', () => {
            audio.play().then(() => {
                isPlaying = true;
                musicIcon.textContent = 'üéµ';
            }).catch(() => {
                console.log('Auto-play prevented - user interaction required');
            });
            
        });
        
        // Music icon click - toggle play/pause
        musicIcon.addEventListener('click', () => {
            if (isPlaying) {
                audio.pause();
                musicIcon.textContent = 'üîá';
                isPlaying = false;
            } else {
                audio.play();
                musicIcon.textContent = 'üéµ';
                isPlaying = true;
            }
        });
        
        // Volume slider
        volumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            audio.volume = volume;
            volumeText.textContent = e.target.value + '%';
            
            // Update icon based on volume
            if (volume === 0) {
                musicIcon.textContent = 'üîá';
            } else {
                musicIcon.textContent = 'üéµ';
            }
        });
        
        // Handle audio end (though loop should prevent this)
        audio.addEventListener('ended', () => {
            audio.currentTime = 0;
            audio.play();
        });
        
        // Socket connection for real-time character updates
        const socket = io();
        
        // Make socket available globally
        window.socket = socket;
        
        // Set up room and player IDs for combat system
        window.currentRoomId = sessionStorage.getItem('currentRoomId');
        window.currentPlayerId = sessionStorage.getItem('currentPlayerId');
        
        // Also try to get from gameData if direct values are null
        if (!window.currentRoomId || !window.currentPlayerId) {
            const gameData = JSON.parse(sessionStorage.getItem('gameData') || '{}');
            if (gameData.roomId) {
                window.currentRoomId = gameData.roomId;
                sessionStorage.setItem('currentRoomId', gameData.roomId);
            }
            if (gameData.players && gameData.players.length > 0) {
                const user = JSON.parse(sessionStorage.getItem('user') || '{}');
                window.currentPlayerId = user.username;
                sessionStorage.setItem('currentPlayerId', user.username);
            }
        }
        
        console.log('Map initialized with:', {
            roomId: window.currentRoomId,
            playerId: window.currentPlayerId,
            gameData: sessionStorage.getItem('gameData'),
            user: sessionStorage.getItem('user')
        });
        
        // Listen for character selection updates
        socket.on('characterSelected', (data) => {
            console.log('Character selection update received on map:', data);
            
            // Update room character selections
            const roomCharacterSelections = JSON.parse(sessionStorage.getItem('roomCharacterSelections') || '{}');
            roomCharacterSelections[data.playerId] = data.character;
            sessionStorage.setItem('roomCharacterSelections', JSON.stringify(roomCharacterSelections));
            
            // Throttled refresh of character sprites
            if (typeof displayCharacterSprites === 'function') {
                if (!window.lastMapSpriteUpdate || (Date.now() - window.lastMapSpriteUpdate) > 2000) {
                    window.lastMapSpriteUpdate = Date.now();
                    displayCharacterSprites();
                }
            }
        });
        
    </script>
</body>
</html>